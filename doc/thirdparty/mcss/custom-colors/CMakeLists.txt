## Customization for m.css layout
##
## Copy the custom files to the m.css source directory, postprocess them
## at this place (where all includes are present) and deploy the resulting
## single css file to the doxygen output directory.
##
## Prerequisites from PARENT:
## - m.css must have been downloaded
## - Targets:   'libarcsdec_mcss_doc'
## - Variables: DOXYGEN_OUTPUT_DIRECTORY
##
## Provides:
## - Target 'libarcsdec_mcss_custom_css' as dependency of
##   parent's 'libarcsdec_mcss_create_html'


## --- Create css output directory {{{1

set (CSS_TARGET_DIR "${DOXYGEN_OUTPUT_DIRECTORY}/html" )

## Take care that the output directory for css files exists
## (Without this script, it would be generated by the doxygen run)
add_custom_command (
	OUTPUT  ${CSS_TARGET_DIR}
	COMMAND ${CMAKE_COMMAND}
	ARGS    -E make_directory ${CSS_TARGET_DIR} )

## Create css target directory
add_custom_target (libarcsdec_create_css_output_dir DEPENDS ${CSS_TARGET_DIR} )



## --- Provide static custom css files to working directory {{{1

## CMake-generated folder for m.css
set (CSS_SOURCE_DIR    "${MCSS_SOURCE_DIR}/css" )

## Provide list of required CSS source files and how to provide them
foreach (FILE IN ITEMS "m-custom.css" "m-theme-custom.css" )

	## List of file dependencies for postprocessing command
	list (APPEND CSS_SOURCE_FILE_LIST "${CSS_SOURCE_DIR}/${FILE}" )

	## For each file dependency: copy file to CSS_SOURCE_DIR
	add_custom_command (
		OUTPUT  ${CSS_SOURCE_DIR}/${FILE}
		DEPENDS ${CMAKE_CURRENT_SOURCE_DIR}/${FILE}
		COMMAND ${CMAKE_COMMAND}
		ARGS -E copy
			${CMAKE_CURRENT_SOURCE_DIR}/${FILE}
			${CSS_SOURCE_DIR}/${FILE}
	)
endforeach()



## --- Compile stylesheet {{{1

## Has to be done in CSS_SOURCE_DIR where the non-custom files to be included
## are present.

## Filename of compiled CSS to deploy
set (CSS_TARGET_FILE   "m-custom+m-documentation.compiled.css" )

## Filepath of compiled CSS to deploy
set (CUSTOM_STYLESHEET "${CSS_SOURCE_DIR}/${CSS_TARGET_FILE}" )

## Create compiled CSS from CSS source fils as explained in
## https://mcss.mosra.cz/documentation/doxygen/#customizing-the-template
## https://mcss.mosra.cz/css/themes/#make-your-own
add_custom_command (
	OUTPUT "${CUSTOM_STYLESHEET}"
	DEPENDS ${CSS_SOURCE_FILE_LIST}
	COMMAND ${CSS_SOURCE_DIR}/postprocess.py
	ARGS ${CSS_SOURCE_FILE_LIST}
		"${CSS_SOURCE_DIR}/m-documentation.css"
		-o "${CUSTOM_STYLESHEET}"
	WORKING_DIRECTORY "${CSS_SOURCE_DIR}"
)



## --- Provide compiled custom css stylesheet to working directory {{{1

## Path of compiled CSS when deployed
set (CUSTOM_STYLESHEET_DEPLOYED "${CSS_TARGET_DIR}/${CSS_TARGET_FILE}" )

## Deploy compiled CSS
add_custom_command (
	OUTPUT  "${CUSTOM_STYLESHEET_DEPLOYED}"
	DEPENDS "${CUSTOM_STYLESHEET}"
	COMMAND ${CMAKE_COMMAND}
	ARGS -E copy
		${CUSTOM_STYLESHEET}
		${CUSTOM_STYLESHEET_DEPLOYED}
)



## --- Define Target libarcsdec_mcss_custom_css {{{1
add_custom_target (libarcsdec_mcss_custom_css
	DEPENDS "${CUSTOM_STYLESHEET_DEPLOYED}" )

add_dependencies  (libarcsdec_mcss_custom_css libarcsdec_create_css_output_dir )

## 1}}}


## --- Activate this script's target

set (MCSS_CUSTOM_STYLESHEET "${CSS_SOURCE_DIR}/${CSS_TARGET_FILE}" PARENT_SCOPE )

add_dependencies (libarcsdec_mcss_create_html libarcsdec_mcss_custom_css )

