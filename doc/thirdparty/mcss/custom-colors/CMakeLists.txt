## CMake Script for Customizing m.css Layout
##
## vim:fdm=marker

## Copy the custom files to the m.css source directory, postprocess them
## at this place (where all includes are present) and deploy the resulting
## single css file to the doxygen output directory.
##
## Prerequisites from PARENT:
## - m.css must have been downloaded
## - Targets:   'libarcsdec_mcss_doc'
## - Variables: DOXYGEN_OUTPUT_DIRECTORY
##
## Provides:
## - Target 'libarcsdec_mcss_custom_css' as dependency of
##   parent's 'libarcsdec_mcss_create_html'


## --- Create CSS output directory {{{1

set (CSS_TARGET_DIR "${DOXYGEN_OUTPUT_DIRECTORY}/html" )

## Take care that the output directory for css files exists
## (Without this script, it would be generated by the doxygen run)
add_custom_command (
	OUTPUT  "${CSS_TARGET_DIR}"
	COMMAND "${CMAKE_COMMAND}"
	ARGS    -E make_directory "${CSS_TARGET_DIR}"
	VERBATIM
)

## Target Directory
add_custom_target (libarcsdec_create_css_output_dir DEPENDS "${CSS_TARGET_DIR}" )



## --- Provide Required CSS Source Files {{{1

## Filename of compiled CSS to deploy
set (CSS_TARGET_FILE   "m-custom+m-documentation.compiled.css" )

## CMake-generated Folder for m.css
set (CSS_SOURCE_DIR    "${MCSS_SOURCE_DIR}/css" )

## Add Source Files to List
foreach (FILE IN ITEMS "m-custom.css" "m-theme-custom.css" )

	## List of file dependencies for postprocessing command
	list (APPEND CSS_SOURCE_FILE_LIST "${CSS_SOURCE_DIR}/${FILE}" )

	## For each file dependency: copy file to CSS_SOURCE_DIR
	add_custom_command (
		OUTPUT  "${CSS_SOURCE_DIR}/${FILE}"
		#DEPENDS "${CMAKE_CURRENT_SOURCE_DIR}/${FILE}"
		COMMAND "${CMAKE_COMMAND}"
		ARGS    -E copy
				"${CMAKE_CURRENT_SOURCE_DIR}/${FILE}"
				"${CSS_SOURCE_DIR}/${FILE}"
		VERBATIM
	)
endforeach()



## --- Compile/Postprocess CSS Style File {{{1
set (CUSTOM_STYLESHEET "${CSS_SOURCE_DIR}/${CSS_TARGET_FILE}" )

## Create compiled CSS from CSS source fils as explained in
## https://mcss.mosra.cz/documentation/doxygen/#customizing-the-template
## https://mcss.mosra.cz/css/themes/#make-your-own
add_custom_command (
	OUTPUT  "${CUSTOM_STYLESHEET}"
	DEPENDS ${CSS_SOURCE_FILE_LIST}
	COMMAND "${CSS_SOURCE_DIR}/postprocess.py"
	ARGS	${CSS_SOURCE_FILE_LIST}
			"${CSS_SOURCE_DIR}/m-documentation.css"
			-o "${CUSTOM_STYLESHEET}"
	WORKING_DIRECTORY "${CSS_SOURCE_DIR}"
	VERBATIM
)

## Path of compiled CSS when deployed
set (CUSTOM_STYLESHEET_TARGET "${CSS_TARGET_DIR}/${CSS_TARGET_FILE}" )

## Deploy compiled CSS
add_custom_command (
	OUTPUT  "${CUSTOM_STYLESHEET_TARGET}"
	DEPENDS "${CUSTOM_STYLESHEET}"
	COMMAND "${CMAKE_COMMAND}"
	ARGS    -E copy
			"${CUSTOM_STYLESHEET}"
			"${CUSTOM_STYLESHEET_TARGET}"
	VERBATIM
)



## --- Target: Provide Custom CSS File {{{1

add_custom_target (libarcsdec_mcss_custom_css
	DEPENDS "${CUSTOM_STYLESHEET_TARGET}"
)

add_dependencies  (libarcsdec_mcss_custom_css libarcsdec_create_css_output_dir )



## --- Activate this Script's Target {{{1
add_dependencies (libarcsdec_mcss_generate_html libarcsdec_mcss_custom_css )


## --- Redo Configuring conf.py (was already done in PARENT) {{{1
configure_file ("${CONFPY_SOURCE}" "${CONFPY}"  @ONLY )
## FIXME Should be configured exactly once!

